<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الورقة الثانية: استراتيجيات الاتساق المتقدمة - بروتوكول AXON</title>
</head>
<body>

# الورقة الثانية: استراتيجيات الاتساق المتقدمة (Secondary Strategies)

تستعرض هذه الورقة الاستراتيجيات الثانوية لبروتوكول AXON، وهي استراتيجيات اختيارية يتم تفعيلها عبر مصفوفة `consistency_strategies` لتلبية متطلبات الدقة العالية والسيادة المطلقة على البيانات.

---

## 1. استراتيجيات مستوى القائمة (List-Level Strategies)

تتحكم هذه الطبقة في منطق "تدفق الأحداث" وترتيب العناصر بالنسبة لبعضها البعض داخل القائمة الواحدة.

### 1.1 الاتساق القوي والنصاب (Strong Consistency & Quorum)
تعتبر هذه الاستراتيجية "إ" في سلم الأولويات عند الحاجة لضمان حالة موحدة ومنع التشعب:
* **حظر الكتابة المنعزلة:** يُمنع الممثل (Actor) تماماً من إضافة أو تعديل أي عنصر في وضع الانعزال (Offline).
* **شرط النصاب (Quorum):** لا تُعتمد العملية إلا بعد الحصول على تأكيد من أغلبية الممثلين أو العقد ($N/2 + 1$). غياب النصاب يحول القائمة إلى وضع "القراءة فقط" لحماية سلامة البيانات.



### 1.2 التتبع السببي (Causal Ordering)
تستخدم الختم الزمني الهجين (HLC) لفرض ترتيب منطقي يضمن أن "السبب يسبق النتيجة":
* **`causal_added`**: يضمن تسلسل ظهور العناصر الجديدة.
* **`causal_updated`**: يضمن وصول التحديثات بترتيبها التاريخي الصحيح.
* **`causal_upserted`**: دمج شامل يضمن سلامة الترتيب في الإضافة والتعديل معاً.

---

## 2. استراتيجيات مستوى الحقل (Field-Level Strategies)

تسمح بتطبيق منطق اتساق متباين داخل العنصر الواحد (Item) عبر الصيغة: `"fieldName:Strategy": value`.

### 2.1 الاتساق القوي للحقل (Field Strong Consistency)
* **الوظيفة:** يعمل كقفل حماية (Lock) على حقول محددة. 
* **السلوك:** بينما يمكن تعديل الحقول الأخرى في العنصر أوفلاين (عبر المستوى الأول)، يظل الحقل الموسوم بـ `Strong` غير قابل للتعديل إلا عند توفر الاتصال وتحقيق النصاب القانوني.

### 2.2 استراتيجية الـ CRDTs (دمج بلا تعارض)

# الورقة الثالثة: استراتيجية الـ CRDTs (Conflict-free Replicated Data Types)

تختص هذه الورقة بتوثيق الحقول التي تتطلب دمجاً ذكياً (Semantic Merging) لضمان "الاتساق النهائي القوي" (Strong Eventual Consistency) دون الحاجة لتدخل الممثل أو حدوث تعارضات منطقية.

---

## 1. فلسفة الدمج في بروتوكول AXON
تعتمد استراتيجية CRDT في البروتوكول على مبدأ أن الحقل ليس مجرد قيمة ثابتة، بل هو **طبقة استمرارية (Persistence Layer)** تخزن تاريخ العمليات أو الحالة الهيكلية للبيانات، مما يسمح بدمج التحديثات المتزامنة من عدة ممثلين بشكل حتمي.



---

## 2. أنواع الـ CRDTs والاشتراطات التشغيلية

تختلف المتطلبات التقنية حسب تعقيد نوع البيانات، حيث يتم تقسيمها إلى فئتين:

### 2.1 الأنواع البسيطة (Standalone CRDTs)
مثل العدادات (`g_counter`, `pn_counter`) والخرائط البسيطة (`map`).
* **النقل:** يمكن مزامنتها عبر السحابة (Cloud) أو P2P.
* **التخزين:** تُخزن حالتها الثنائية مباشرة داخل الحقل في الـ Replica.

### 2.2 الأنواع المعقدة والتعاونية (Collaborative CRDTs)
مثل النصوص المنسقة (`rich_text`) والجداول والقوائم المتحركة (`movable_list`) والأشجار (`tree`).
تخضع هذه الأنواع للمتطلبات الإلزامية التالية:

* **إلزامية قناة الـ P2P:** نظراً لتدفق التغييرات الكثيف والحاجة لزمن تأخير يقارب الصفر (Real-time)، تشترط هذه الأنواع وجود قناة **ند لند (Peer-to-Peer)** مباشرة لنقل الدلتا (Deltas) بين الممثلين دون انتظار وسيط سحابي.
* **إلزامية الـ Blob Driver:** بسبب تراكم البيانات الوصفية (Metadata) في هذه الأنواع، يتجاوز حجم الحالة الثنائية غالباً قدرة استيعاب الحقول التقليدية. هنا يصبح استخدام الـ **Blob Driver** إلزامياً لتخزين الحالة في ملفات منفصلة ومزامنتها ككتل بيانات ضخمة.

---

## 3. تمثيل القيمة (Value Structure)
يتم التعبير عن قيمة حقل الـ CRDT بصيغتين بناءً على الحجم والنوع:
1. **Binary Data:** مصفوفة ثنائية (Array of Binary) تحتوي على سجل العمليات (OpLog) أو ناقل الحالة (State Vector).
2. **Blob Reference:** رابط مرجعي (URL/Path) يشير إلى الملف المدار بواسطة الـ Blob Driver في حالات البيانات الضخمة (مثل Rich Text).



---

## 4. مصفوفة اشتراطات أنواع الـ CRDT

| نوع الـ CRDT | إلزامية P2P | إلزامية Blob Driver | طبيعة البيانات |
| :--- | :--- | :--- | :--- |
| **g_counter / pn_counter** | اختياري | غير مطلوب | قيم رقمية تراكمية |
| **map / g_set** | اختياري | اختياري (حسب الحجم) | مفاتيح وقيم |
| **text / rich_text** | **إلزامي** | **إلزامي** | نصوص تعاونية لحظية |
| **ordered / movable_list** | **إلزامي** | اختياري | عناصر مرتبة حتمياً |
| **tree** | **إلزامي** | **إلزامي** | هياكل هرمية معقدة |

---

## 5. تنويه تقني
تعمل الحقول المستهدفة بهذه الاستراتيجية كـ "مستودع حالة ثنائية"؛ حيث يقوم الممثل عند استلام أي تحديث عبر قناة الـ P2P بتمرير الثنائيات إلى محرك الـ CRDT الخاص بالنوع، ثم تحديث طبقة الاستمرارية محلياً وإخطار الواجهة بالنتيجة النهائية المدمجة.


---

## 3. ملخص مصفوفة القرار للاستراتيجيات الثانوية

| النوع | الاستراتيجية | قناة النقل | وضع الانعزال | شرط النصاب | طبقة البيانات |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **List** | **Strong** | Cloud | **ممنوع** | **إلزامي** | حالة موحدة (Consensus) |
| **List** | Causal | P2P / Cloud | مسموح | غير مطلوب | ترتيب تدفق (HLC) |
| **Field** | **Strong** | Cloud | **ممنوع** | **إلزامي** | حقل محمي |
| **Field** | **CRDTs** | **P2P الصرفة** | مسموح | غير مطلوب | **استمرارية ثنائية / Blob** |

</body>
</html>

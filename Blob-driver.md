m<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
</head>
<body>

# توثيق محرك إدارة الملفات: Blob Driver (بروتوكول myReplica)

يعتبر **Blob Driver** الطبقة المسؤولة عن إدارة واستمرارية البيانات الضخمة (Binary Large Objects) والملفات المرتبطة بـ **myReplica**. صُمم ليعمل كخادم للأصول (Assets) وسند استمراري للعمليات المعقدة مثل لقطات الحالة (CRDT Snapshots).

---

## 1. المفهوم والفلسفة
يتم فصل الملفات عن هيكل البيانات الأساسي (`Item`) لضمان خفة المزامنة. يحتوي الحقل المستهدف (Field) في النسخة المتماثلة على "مرجع" أو "رابط" للملف، بينما يتولى الـ **Blob Driver** إدارة الوجود الفيزيائي لهذا الملف.

### **ثنائية الدور:**
1.  **إدارة الوسائط:** (صور، فيديو، مستندات) المرتبطة ببيانات المستخدم (مثل `userItem.photoUrl`).
2.  **استمرارية الـ CRDTs:** تخزين لقطات الحالة الثنائية (**Snapshot Binary**) لتقليل حجم سجل العمليات وتحسين أداء الدمج (Merge).

---

## 2. استراتيجية التموضع (Placement Strategy)
يعتمد المحرك مبدأ **"البعيد أولاً، المحلي عند الحاجة" (Remote First, Local as Needed)**:

* **Remote Source First:** الأولوية لتخزين الملفات في السحابة (Cloud Storage) أو أنظمة التخزين الموزعة مثل (**DMC** أو **ECN**) لضمان القابلية للمشاركة بين الممثلين.
* **Collocation:** عند توفر **Cloud Replica**، يُفضل دمج الـ Blob Driver في نفس بيئة السيرفر لتوحيد نقطة الوصول.
* **Local Fallback:** يتم التخزين محلياً بجانب الـ **First Replica** في حالات الانعزال (Offline) أو حسب تفضيلات الخصوصية التي يحددها الممثل.

---

## 3. خيارات التوفر والتخزين المحلي (Local Persistence Policies)
يمنح المطور والمستخدم 5 مستويات للتحكم في استهلاك المساحة والنطاق:

1.  **تزامن محلي كامل (Full Offline):** تنزيل استباقي لكافة الملفات لضمان عملها دون إنترنت.
2.  **التنزيل عند الاستدعاء (Lazy Load):** لا يتم تحميل الملف إلا عند أول محاولة وصول أو عرض.
3.  **الفرز حسب الأهمية (Priority Sync):** مزامنة الملفات الصغيرة أو الهامة تلقائياً، وترك الكبيرة للتنزيل اليدوي.
4.  **الإدارة الديناميكية (Smart Quota):** تحديد مساحة تخزين قصوى (مثلاً 5GB) مع ميزة الحذف التلقائي للملفات القديمة محلياً (LRU).
5.  **التحكم اليدوي (Manual API):** توفير واجهة صريحة للمستخدم لعمل (Download) أو (Delete Local).

---

## 4. الميزات التقنية المتقدمة

### **أ. المعاينة اللحظية (previewUrl)**
يوفر البروتوكول حقل `previewUrl` مباشر داخل الـ `Field`. هذا الحقل يحتوي على نسخة مصغرة (Thumbnail) أو Base64 منخفض الجودة، مما يسمح بعرض المحتوى فوراً قبل اكتمال تحميل الملف الأصلي الضخم من الـ Blob Driver.



### **ب. استمرارية الـ CRDT Snapshots**
بما أن **myReplica** يدعم CRDTs على مستوى الحقل، يقوم الـ Blob Driver بدور حيوي:
* يتم ضغط سجل العمليات الطويل وتحويله إلى **Binary Snapshot**.
* يُخزن هذا الـ Binary في الـ Blob Driver.
* عند المزامنة، يحمل الممثل الـ Snapshot كقاعدة أساس، ثم يطبق فوقها التغييرات (Deltas) اللاحقة، مما يسرع عملية الإقلاع (Fast Boot).

---

## 5. الخلاصة المعمارية
يعمل الـ **Blob Driver** كجسر ذكي؛ فهو يحرر النسخة المتماثلة من ثقل الملفات الكبيرة، ويضمن في الوقت نفسه أن يكون الممثل (Actor) هو المتحكم الوحيد في أين وكيف تُخزن ملفاته، سواء كانت مشفرة في السحابة أو محفوظة محلياً للوصول السريع.

</body>
</html>
